#!/usr/bin/env python3
"""
Reader - Seminar-style reading companion.

Usage:
    ./read                      # Launch reader TUI
    ./read --extract <id>       # Extract chapters from a material
    ./read --list               # List registered materials
    ./read --help               # Show help
"""
import argparse
import os
import sys

# Ensure local imports (reader/, tui/, reviewer/)
sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))


def print_help() -> None:
    print("""
Reader - Seminar-style reading companion

Usage:
    ./read                      Launch the reader TUI
    ./read --extract <id>       Extract chapters from a registered material
    ./read --list               List registered materials
    ./read --test-llm           Test LLM provider configuration
    ./read --clear <id> [ch]    Clear session(s) for a material (all or specific chapter)
    ./read --help               Show this help message

Examples:
    ./read --list
    ./read --extract build-llm-from-scratch
    ./read --clear ALL                         # Clear all sessions for all materials
    ./read --clear build-llm-from-scratch      # Clear all sessions for one material
    ./read --clear build-llm-from-scratch 1    # Clear chapter 1 only
    ./read --test-llm

The reader brings St. John's College seminar pedagogy to self-study
through structured LLM dialogue grounded in the actual text.
""")


def list_materials() -> None:
    """List all registered materials."""
    from reader.config import load_registry

    registry = load_registry()
    if not registry.get("materials"):
        print("No materials registered. Add materials to reader/content_registry.yaml")
        return

    print("\nRegistered Materials:\n")
    for material_id, info in registry["materials"].items():
        title = info.get("title", material_id)
        author = info.get("author", "Unknown")
        chapters = len(info.get("structure", {}).get("chapters", []))
        print(f"  {material_id}")
        print(f"    {title} ({author})")
        print(f"    {chapters} chapters")
        print()


def extract_material(material_id: str) -> None:
    """Extract chapters from a material."""
    from reader.content import extract_material as do_extract

    print(f"Extracting: {material_id}")
    try:
        do_extract(material_id)
        print(f"Done. Check reader/extracted/{material_id}/")
    except Exception as e:
        print(f"Error: {e}")
        sys.exit(1)


def clear_sessions(material_id: str, chapter: int | None = None) -> None:
    """Clear session data for a material (or all materials if 'ALL')."""
    from pathlib import Path
    import shutil

    sessions_root = Path(__file__).parent / "reader" / "sessions"

    if material_id.upper() == "ALL":
        # Clear everything
        if not sessions_root.exists():
            print("No sessions found.")
            return
        materials = list(sessions_root.iterdir())
        if not materials:
            print("No sessions found.")
            return
        shutil.rmtree(sessions_root)
        sessions_root.mkdir()
        print(f"Cleared all sessions ({len(materials)} materials)")
        return

    sessions_dir = sessions_root / material_id

    if not sessions_dir.exists():
        print(f"No sessions found for: {material_id}")
        return

    if chapter is not None:
        # Clear specific chapter
        files = [
            sessions_dir / f"ch{chapter:02d}.jsonl",
            sessions_dir / f"ch{chapter:02d}.meta.json",
        ]
        deleted = 0
        for f in files:
            if f.exists():
                f.unlink()
                deleted += 1
        if deleted:
            print(f"Cleared session for {material_id} chapter {chapter}")
        else:
            print(f"No session found for {material_id} chapter {chapter}")
    else:
        # Clear all sessions for this material
        shutil.rmtree(sessions_dir)
        print(f"Cleared all sessions for: {material_id}")


def test_llm() -> None:
    """Test LLM provider configuration."""
    from reader.llm import get_provider

    print("Testing LLM provider...")
    try:
        provider = get_provider()
        print(f"  Provider: {provider.__class__.__name__}")
        if hasattr(provider, "model_name"):
            print(f"  Model: {provider.model_name}")
        elif hasattr(provider, "model"):
            print(f"  Model: {provider.model}")

        print("\nSending test message...")
        response = provider.chat(
            messages=[{"role": "user", "content": "Say 'Hello from Reader!' and nothing else."}]
        )
        print(f"  Response: {response.strip()}")
        print("\nLLM integration working!")
    except Exception as e:
        print(f"Error: {e}")
        sys.exit(1)


def run_tui() -> None:
    """Launch the reader TUI."""
    try:
        from tui.app import ReaderApp
        app = ReaderApp()
        app.run()
    except ImportError as e:
        print(f"Error starting reader TUI: {e}")
        print("Try running: uv run ./read")
        sys.exit(1)


def main() -> None:
    parser = argparse.ArgumentParser(
        description="Reader - Seminar-style reading companion",
        add_help=False
    )
    parser.add_argument("--help", "-h", action="store_true", help="Show help")
    parser.add_argument("--list", "-l", action="store_true", help="List materials")
    parser.add_argument("--extract", "-e", metavar="ID", help="Extract material")
    parser.add_argument("--test-llm", action="store_true", help="Test LLM provider")
    parser.add_argument("--clear", "-c", nargs="+", metavar=("ID", "CH"), help="Clear sessions")

    args = parser.parse_args()

    if args.help:
        print_help()
    elif args.list:
        list_materials()
    elif args.extract:
        extract_material(args.extract)
    elif args.test_llm:
        test_llm()
    elif args.clear:
        material_id = args.clear[0]
        chapter = int(args.clear[1]) if len(args.clear) > 1 else None
        clear_sessions(material_id, chapter)
    else:
        run_tui()


if __name__ == "__main__":
    main()
