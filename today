#!/usr/bin/env -S uv run python3
"""
Daily study dashboard - CLI version.

Shows today's domain, reviewer status, and next task.
This is the CLI equivalent of the TUI dashboard.
"""
import datetime
from pathlib import Path

# Import from shared data layer
from reviewer.core import (
    get_todays_domain,
    get_next_task,
    get_reviewer_summary,
    get_overall_progress,
    collect_focus_files,
)

# Import from reader module
from reader.config import load_registry
from reader.session import list_sessions, SESSIONS_DIR

# ANSI Colors
BOLD = '\033[1m'
GREEN = '\033[32m'
YELLOW = '\033[33m'
CYAN = '\033[36m'
DIM = '\033[2m'
RESET = '\033[0m'


def print_header():
    date_str = datetime.date.today().strftime("%A, %B %d, %Y")
    print(f"{BOLD}╔════════════════════════════════════════╗{RESET}")
    print(f"{BOLD}║           TODAY'S STUDY PLAN           ║{RESET}")
    print(f"{BOLD}║  {CYAN}{date_str:<26}{RESET}{BOLD}     ║{RESET}")
    print(f"{BOLD}╚════════════════════════════════════════╝{RESET}")
    print()


def print_domain():
    domain, override = get_todays_domain()
    
    if override:
        print(f"{BOLD}Current Phase:{RESET} {YELLOW}{domain}{RESET}")
        print(f"{DIM}{override}{RESET}")
    else:
        print(f"{BOLD}Domain:{RESET} {GREEN}{domain}{RESET}")
    print()


def print_reviewer_status():
    print(f"{BOLD}Reviewer:{RESET}")
    
    try:
        summary = get_reviewer_summary()
        
        box_zero = summary["box_zero"]
        overdue = summary["overdue"]
        due_now = summary["due_now"]
        never_practiced = summary["never_practiced"]
        total_due = box_zero + overdue + due_now
        
        if box_zero > 0:
            print(f"  {YELLOW}Box 0 (failed): {box_zero} cards{RESET}")
        if overdue > 0:
            print(f"  {YELLOW}Overdue: {overdue} cards{RESET}")
        if due_now > 0:
            print(f"  {GREEN}Due now: {due_now} cards{RESET}")
        if total_due == 0:
            print(f"  {GREEN}All caught up!{RESET}")
        if never_practiced > 0:
            print(f"  {DIM}Never practiced: {never_practiced} cards{RESET}")
        
        if summary["last_practiced"]:
            # Show just the date portion
            last_date = summary["last_practiced"][:10]
            print(f"  {DIM}Last practiced: {last_date}{RESET}")
            
    except Exception as e:
        print(f"  {DIM}(error reading reviewer data: {e}){RESET}")
    
    print()


def print_card_summary():
    focus_files = collect_focus_files()
    count = len(focus_files)

    if count > 0:
        print(f"{BOLD}Reviewer Library:{RESET}")
        print(f"  {DIM}Focus cards: {count}{RESET}")
        print()


def print_reader_status():
    print(f"{BOLD}Reader:{RESET}")

    try:
        # Count registered materials
        registry = load_registry()
        materials = registry.get("materials", {})
        material_count = len(materials)

        # Find all sessions across all materials
        all_sessions = []
        if SESSIONS_DIR.exists():
            for material_dir in SESSIONS_DIR.iterdir():
                if material_dir.is_dir():
                    material_id = material_dir.name
                    sessions = list_sessions(material_id)
                    for chapter_num, session in sessions.items():
                        # Get material title if available
                        material_info = materials.get(material_id, {})
                        title = material_info.get("title", material_id)
                        all_sessions.append((session, title))

        if not all_sessions:
            print(f"  {DIM}No reading sessions yet{RESET}")
            print(f"  {DIM}Materials: {material_count} registered{RESET}")
        else:
            # Find most recent session
            all_sessions.sort(key=lambda x: x[0].last_updated, reverse=True)
            last_session, last_title = all_sessions[0]

            # Format the time ago
            now = datetime.datetime.now()
            delta = now - last_session.last_updated
            if delta.days == 0:
                time_ago = "today"
            elif delta.days == 1:
                time_ago = "yesterday"
            else:
                time_ago = f"{delta.days} days ago"

            # Truncate title if too long
            display_title = last_title if len(last_title) <= 30 else last_title[:27] + "..."

            print(f"  Last session: {display_title}, Ch {last_session.chapter_num} ({time_ago})")
            print(f"  {DIM}In progress: {len(all_sessions)} chapter(s) · Materials: {material_count}{RESET}")

    except Exception as e:
        print(f"  {DIM}(error reading reader data: {e}){RESET}")

    print()


def print_next_task():
    done, total = get_overall_progress()
    if total == 0:
        return

    print(f"{BOLD}Phase 0 Progress:{RESET} {done}/{total} tasks complete")

    next_task = get_next_task()
    if next_task:
        print(f"  {CYAN}Next:{RESET}  {next_task}")
    else:
        print(f"  {GREEN}All Phase 0 tasks complete!{RESET}")

    print()


def print_quick_commands():
    print(f"{BOLD}Quick Commands:{RESET}")
    print(f"  {GREEN}./study{RESET}                  # Launch TUI (recommended)")
    print(f"  {GREEN}./drill{RESET}                  # Drill due cards (Textual TUI)")
    print(f"  {GREEN}./read{RESET}                   # Reading companion (dialogue)")
    print(f"  {DIM}./study --progress{RESET}       # Generate progress report")
    print()


def main():
    print_header()
    print_domain()
    print_reviewer_status()
    print_reader_status()
    print_card_summary()
    print_next_task()
    print_quick_commands()


if __name__ == "__main__":
    main()
